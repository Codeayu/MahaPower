{% extends "base.html" %}
{% load static %}

{% block title %}Edit Work Suggestion{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="text-center mb-10">
        <h2 class="text-3xl font-bold text-gray-800 mb-2 english-text">Edit Work Suggestion</h2>
        <h2 class="text-3xl font-bold text-gray-800 mb-2 marathi-text hidden">कामाच्या सूचना संपादित करा</h2>
        <div class="w-20 h-1 bg-saffron mx-auto mb-4"></div>
        <p class="text-gray-600 max-w-2xl mx-auto english-text">Update the location or work type for this suggestion.</p>
        <p class="text-gray-600 max-w-2xl mx-auto marathi-text hidden">या सूचनेसाठी स्थान किंवा कामाचा प्रकार अपडेट करा.</p>
    </div>

    <!-- Language Toggle Section -->
    <div class="flex justify-end mb-6">
        <div class="flex bg-white rounded-full p-1 shadow-sm">
            <button type="button" id="englishBtn" class="px-4 py-1.5 rounded-full bg-saffron text-white text-sm font-medium transition-all duration-200">English</button>
            <button type="button" id="marathiBtn" class="px-4 py-1.5 rounded-full text-gray-700 text-sm font-medium transition-all duration-200">मराठी</button>
        </div>
    </div>

    <!-- Edit Form Section -->
    <div class="rounded-xl shadow-lg overflow-hidden border border-gray-200 mb-10 transform transition-all duration-300 hover:shadow-xl">
        <div class="p-5 bg-gradient-to-r from-navyBlue to-blue-700 text-white">
            <div class="flex flex-wrap justify-between items-center">
                <h4 class="text-2xl font-semibold english-text mb-2 md:mb-0">Edit Work Suggestion</h4>
                <h4 class="text-2xl font-semibold marathi-text hidden mb-2 md:mb-0">कामाच्या सूचना संपादित करा</h4>
            </div>
        </div>
        
        <div class="p-6 bg-white">
            <form method="post" class="grid grid-cols-1 md:grid-cols-2 gap-6" id="editSuggestionForm">
                {% csrf_token %}
                
                <!-- Current Information Box -->
                <div class="col-span-1 md:col-span-2 bg-blue-50 p-4 rounded-lg border border-blue-100 mb-2">
                    <h5 class="font-semibold text-blue-800 mb-3 english-text">Current Information</h5>
                    <h5 class="font-semibold text-blue-800 mb-3 marathi-text hidden">सध्याची माहिती</h5>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 english-text">Current Location</p>
                            <p class="text-sm text-gray-600 marathi-text hidden">वर्तमान स्थान</p>
                            <p class="font-medium text-gray-800">{{ suggestion.gram_panchayat.name }}, {{ suggestion.gram_panchayat.taluka.name }}, {{ suggestion.gram_panchayat.taluka.district.name }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 english-text">Current Work Type</p>
                            <p class="text-sm text-gray-600 marathi-text hidden">वर्तमान कामाचा प्रकार</p>
                            <p class="font-medium text-gray-800">{{ suggestion.work_type.name_en }} ({{ suggestion.work_type.sector }})</p>
                        </div>
                    </div>
                </div>
                
                <!-- District Dropdown -->
                <div class="relative">
                    <label for="district" class="block text-sm font-medium text-gray-600 mb-1.5 english-text">District</label>
                    <label for="district" class="block text-sm font-medium text-gray-600 mb-1.5 marathi-text hidden">जिल्हा</label>
                    <select id="district" name="district" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-saffron focus:border-transparent appearance-none bg-white">
                        <option value="">Select District</option>
                        {% for district in districts %}
                            <option value="{{ district.id }}" {% if district.id == suggestion.gram_panchayat.taluka.district.id %}selected{% endif %}>{{ district.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 pt-6">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Taluka Dropdown -->
                <div class="relative">
                    <label for="taluka" class="block text-sm font-medium text-gray-600 mb-1.5 english-text">Taluka</label>
                    <label for="taluka" class="block text-sm font-medium text-gray-600 mb-1.5 marathi-text hidden">तालुका</label>
                    <select id="taluka" name="taluka" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-saffron focus:border-transparent appearance-none bg-white">
                        <option value="">Select Taluka</option>
                        {% for taluka in talukas %}
                            <option value="{{ taluka.id }}" {% if taluka.id == suggestion.gram_panchayat.taluka.id %}selected{% endif %}>{{ taluka.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 pt-6">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"></path>
                        </svg>
                    </div>
                    <div id="taluka-loading" class="hidden absolute right-10 top-1/2 transform -translate-y-1/3">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-saffron"></div>
                    </div>
                </div>

                <!-- Gram Panchayat Dropdown -->
                <div class="relative">
                    <label for="gram_panchayat" class="block text-sm font-medium text-gray-600 mb-1.5 english-text">Gram Panchayat</label>
                    <label for="gram_panchayat" class="block text-sm font-medium text-gray-600 mb-1.5 marathi-text hidden">ग्रामपंचायत</label>
                    <select id="gram_panchayat" name="gram_panchayat" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-saffron focus:border-transparent appearance-none bg-white">
                        <option value="">Select Gram Panchayat</option>
                        {% for gram in grams %}
                            <option value="{{ gram.id }}" {% if gram.id == suggestion.gram_panchayat.id %}selected{% endif %}>{{ gram.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 pt-6">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"></path>
                        </svg>
                    </div>
                    <div id="gp-loading" class="hidden absolute right-10 top-1/2 transform -translate-y-1/3">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-saffron"></div>
                    </div>
                </div>

                <!-- Sector Dropdown -->
                <div class="relative">
                    <label for="sector" class="block text-sm font-medium text-gray-600 mb-1.5 english-text">Sector</label>
                    <label for="sector" class="block text-sm font-medium text-gray-600 mb-1.5 marathi-text hidden">क्षेत्र</label>
                    <select id="sector" name="sector" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-saffron focus:border-transparent appearance-none bg-white">
                        <option value="">Select Sector</option>
                        {% for sec in sectors %}
                            <option value="{{ sec }}" {% if sec == suggestion.work_type.sector %}selected{% endif %}>{{ sec }}</option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 pt-6">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- Work Type Dropdown -->
                <div class="relative col-span-1 md:col-span-2">
                    <label for="work_type" class="block text-sm font-medium text-gray-600 mb-1.5 english-text">Work Type</label>
                    <label for="work_type" class="block text-sm font-medium text-gray-600 mb-1.5 marathi-text hidden">कामाचा प्रकार</label>
                    <select id="work_type" name="work_type" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-saffron focus:border-transparent appearance-none bg-white">
                        <option value="">Select Work Type</option>
                        {% for work_type in work_types %}
                            <option value="{{ work_type.id }}" {% if work_type.id == suggestion.work_type.id %}selected{% endif %}>{{ work_type.name_en }}</option>
                        {% endfor %}
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 pt-6">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"></path>
                        </svg>
                    </div>
                    <div id="work-type-loading" class="hidden absolute right-10 top-1/2 transform -translate-y-1/3">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-saffron"></div>
                    </div>
                </div>

                <!-- Button Row -->
                <div class="col-span-1 md:col-span-2 flex justify-between items-center mt-4">
                    <!-- Cancel Button -->
                    <a href="{% url 'suggestion_management' %}" class="py-2.5 px-8 rounded-lg text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 hover:shadow-md transition-all duration-300 transform hover:-translate-y-0.5 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span class="english-text">Cancel</span>
                        <span class="marathi-text hidden">रद्द करा</span>
                    </a>

                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn" class="py-2.5 px-8 rounded-lg text-sm font-semibold bg-gradient-to-r from-green-600 to-green-500 text-white hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                        <span class="english-text flex items-center">
                            Save Changes
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </span>
                        <span class="marathi-text hidden flex items-center">
                            बदल जतन करा
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Language toggle functionality
document.getElementById('englishBtn').addEventListener('click', function() {
    document.querySelectorAll('.english-text').forEach(el => el.classList.remove('hidden'));
    document.querySelectorAll('.marathi-text').forEach(el => el.classList.add('hidden'));
    this.classList.add('bg-saffron', 'text-white');
    document.getElementById('marathiBtn').classList.remove('bg-saffron', 'text-white');
});

document.getElementById('marathiBtn').addEventListener('click', function() {
    document.querySelectorAll('.english-text').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.marathi-text').forEach(el => el.classList.remove('hidden'));
    this.classList.add('bg-saffron', 'text-white');
    document.getElementById('englishBtn').classList.remove('bg-saffron', 'text-white');
});

// District dropdown change handler
document.getElementById('district').addEventListener('change', function () {
    const talukaSelect = document.getElementById('taluka');
    const gpSelect = document.getElementById('gram_panchayat');
    const loading = document.getElementById('taluka-loading');
    
    // Reset subsequent dropdowns
    talukaSelect.innerHTML = '<option value="">Select Taluka</option>';
    gpSelect.innerHTML = '<option value="">Select Gram Panchayat</option>';
    
    if (!this.value) {
        return;
    }
    
    // Show loading indicator
    talukaSelect.disabled = true;
    loading.classList.remove('hidden');
    
    // Fetch talukas for the selected district
    fetch(`/get-talukas/?district_id=${this.value}`)
        .then(res => res.json())
        .then(data => {
            talukaSelect.innerHTML = '<option value="">Select Taluka</option>';
            data.forEach(t => {
                talukaSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
            });
        })
        .catch(err => {
            console.error('Error loading talukas:', err);
        })
        .finally(() => {
            talukaSelect.disabled = false;
            loading.classList.add('hidden');
        });
});

// Taluka dropdown change handler
document.getElementById('taluka').addEventListener('change', function () {
    const gpSelect = document.getElementById('gram_panchayat');
    const loading = document.getElementById('gp-loading');
    
    // Reset gram panchayat dropdown
    gpSelect.innerHTML = '<option value="">Select Gram Panchayat</option>';
    
    if (!this.value) {
        return;
    }
    
    // Show loading indicator
    gpSelect.disabled = true;
    loading.classList.remove('hidden');
    
    // Fetch gram panchayats for the selected taluka
    fetch(`/get-gram-panchayats/?taluka_id=${this.value}`)
        .then(res => res.json())
        .then(data => {
            gpSelect.innerHTML = '<option value="">Select Gram Panchayat</option>';
            data.forEach(gp => {
                gpSelect.innerHTML += `<option value="${gp.id}">${gp.name}</option>`;
            });
        })
        .catch(err => {
            console.error('Error loading gram panchayats:', err);
        })
        .finally(() => {
            gpSelect.disabled = false;
            loading.classList.add('hidden');
        });
});

// Sector dropdown change handler
document.getElementById('sector').addEventListener('change', function () {
    const workTypeSelect = document.getElementById('work_type');
    const loading = document.getElementById('work-type-loading');
    
    // Reset work type dropdown
    workTypeSelect.innerHTML = '<option value="">Select Work Type</option>';
    
    if (!this.value) {
        return;
    }
    
    // Show loading indicator
    workTypeSelect.disabled = true;
    if (loading) loading.classList.remove('hidden');
    
    // Fetch work types for the selected sector
    fetch(`/get-work-types/?sector=${this.value}`)
        .then(res => res.json())
        .then(data => {
            workTypeSelect.innerHTML = '<option value="">Select Work Type</option>';
            data.forEach(wt => {
                workTypeSelect.innerHTML += `<option value="${wt.id}">${wt.name_en}</option>`;
            });
        })
        .catch(err => {
            console.error('Error loading work types:', err);
        })
        .finally(() => {
            workTypeSelect.disabled = false;
            if (loading) loading.classList.add('hidden');
        });
});

// Form submission with AJAX
document.getElementById('editSuggestionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalBtnText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.disabled = true;
    const isEnglish = !document.querySelector('.english-text').classList.contains('hidden');
    submitBtn.innerHTML = `<div class="flex items-center justify-center">
                              <div class="animate-spin h-5 w-5 border-2 border-white rounded-full border-t-transparent mr-2"></div>
                              <span>${isEnglish ? 'Saving...' : 'जतन करत आहे...'}</span>
                           </div>`;
    
    // Prepare form data
    const formData = new FormData(this);
    
    // Send AJAX request
    fetch('', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Show success message
            showNotification(data.message, 'success');
            
            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = "{% url 'suggestion_management' %}";
            }, 1500);
        } else {
            // Show error message
            showNotification(data.message, 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification(isEnglish ? 'An error occurred while processing your request' : 'आपली विनंती प्रक्रिया करताना त्रुटी आली', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    });
});

// Function to display notifications
function showNotification(message, type = 'success') {
    // Remove any existing notifications
    const existingNotification = document.getElementById('notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg flex items-center z-50 ${
        type === 'success' ? 'bg-green-50 text-green-700 border-l-4 border-green-500' : 
        'bg-red-50 text-red-700 border-l-4 border-red-500'
    } transform transition-all duration-500 translate-y-20 opacity-0`;
    
    // Add notification content
    notification.innerHTML = `
        <div class="mr-3 bg-white bg-opacity-25 rounded-full p-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${type === 'success' 
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' 
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                }
            </svg>
        </div>
        <p class="font-medium">${message}</p>
    `;
    
    // Add to DOM
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-y-20', 'opacity-0');
    }, 10);
    
    // Automatically remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('translate-y-20', 'opacity-0');
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}
</script>
{% endblock %}